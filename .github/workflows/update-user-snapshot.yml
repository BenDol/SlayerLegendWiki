name: Update User Profile Snapshot

# This workflow automatically updates a user's profile snapshot when their PR is merged.
# Snapshots store comprehensive profile data (stats, PRs, user info) in GitHub issues.
# This allows viewing detailed profiles for all users, not just those with recent PRs.
#
# The snapshots are stored in GitHub issues with the label "user-snapshot"
# and title "[User Snapshot] username"
#
# Triggers:
# - When a PR is closed (merged)
# - Manually via GitHub UI (Actions tab)
on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      username:
        description: 'GitHub username to update snapshot for'
        required: true
        type: string

jobs:
  update-snapshot:
    # Only run if PR was merged (not just closed) or manually triggered
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write  # Need write permission to create/update snapshot issues
      pull-requests: read  # Need read permission to fetch PR data

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update user snapshot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const SNAPSHOT_LABEL = 'user-snapshot';
            const SNAPSHOT_TITLE_PREFIX = '[User Snapshot]';

            // Get username from PR author or manual input
            const username = context.payload.inputs?.username || context.payload.pull_request.user.login;

            console.log(`üîç Building profile snapshot for @${username}...`);

            // Fetch user data
            const { data: userData } = await github.rest.users.getByUsername({
              username: username,
            });

            console.log(`‚úÖ User data fetched: ${userData.name || username}`);

            // Fetch all PRs by this user
            console.log('üîç Fetching pull requests...');
            const allPRs = [];
            let page = 1;
            let hasMore = true;

            while (hasMore) {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page: page,
              });

              // Filter PRs by this user
              const userPRs = prs.filter(pr => pr.user.login === username);
              allPRs.push(...userPRs);

              hasMore = prs.length === 100;
              page++;
            }

            console.log(`‚úÖ Found ${allPRs.length} PRs for @${username}`);

            // Calculate statistics
            const stats = {
              totalPRs: allPRs.length,
              openPRs: allPRs.filter(pr => pr.state === 'open').length,
              mergedPRs: allPRs.filter(pr => pr.merged_at || pr.state === 'merged').length,
              closedPRs: allPRs.filter(pr => (pr.state === 'closed' || pr.state === 'merged') && !pr.merged_at).length,
              totalAdditions: allPRs.reduce((sum, pr) => sum + (pr.additions || 0), 0),
              totalDeletions: allPRs.reduce((sum, pr) => sum + (pr.deletions || 0), 0),
              totalFiles: allPRs.reduce((sum, pr) => sum + (pr.changed_files || 0), 0),
              mostRecentEdit: allPRs.length > 0
                ? new Date(Math.max(...allPRs.map(pr => new Date(pr.created_at).getTime()))).toISOString()
                : null,
            };

            // Build pull requests list (store essential data)
            // Limit to most recent 100 PRs to stay within GitHub issue size limits (~65KB)
            const recentPRs = allPRs
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(0, 100);

            console.log(`üìù Storing ${recentPRs.length} most recent PRs (out of ${allPRs.length} total)`);

            const pullRequests = recentPRs.map(pr => ({
              number: pr.number,
              title: pr.title,
              state: pr.state,
              created_at: pr.created_at,
              updated_at: pr.updated_at,
              merged_at: pr.merged_at,
              closed_at: pr.closed_at,
              additions: pr.additions,
              deletions: pr.deletions,
              changed_files: pr.changed_files,
              html_url: pr.html_url,
              labels: pr.labels.map(label => ({
                name: label.name,
                color: label.color,
              })),
            }));

            // Build snapshot object
            const snapshot = {
              username: username,
              lastUpdated: new Date().toISOString(),
              stats: stats,
              pullRequests: pullRequests,
              pullRequestsCount: allPRs.length,
              pullRequestsStored: recentPRs.length,
              pullRequestsTruncated: allPRs.length > 100,
              user: {
                login: userData.login,
                name: userData.name,
                avatar_url: userData.avatar_url,
                bio: userData.bio,
              },
            };

            console.log('üìä Snapshot statistics:');
            console.log(`   Total PRs: ${stats.totalPRs}`);
            console.log(`   Merged: ${stats.mergedPRs}`);
            console.log(`   Additions: +${stats.totalAdditions.toLocaleString()}`);
            console.log(`   Deletions: -${stats.totalDeletions.toLocaleString()}`);
            console.log(`   Files: ${stats.totalFiles}`);

            // Find existing snapshot issue
            console.log('üîç Looking for existing snapshot issue...');
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: SNAPSHOT_LABEL,
              state: 'open',
              per_page: 100,
            });

            const existingIssue = issues.find(
              issue => issue.title === `${SNAPSHOT_TITLE_PREFIX} ${username}`
            );

            const issueTitle = `${SNAPSHOT_TITLE_PREFIX} ${username}`;
            const issueBody = JSON.stringify(snapshot, null, 2);

            let issueNumber;

            if (existingIssue) {
              // Update existing snapshot
              issueNumber = existingIssue.number;
              console.log(`üìù Updating existing snapshot issue #${issueNumber}...`);

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: issueBody,
              });
            } else {
              // Create new snapshot
              console.log('üìù Creating new snapshot issue...');

              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: [SNAPSHOT_LABEL, 'automated'],
              });

              issueNumber = newIssue.number;
            }

            console.log(`‚úÖ Snapshot saved successfully!`);
            console.log(`   User: @${username}`);
            console.log(`   Issue: #${issueNumber}`);
            console.log(`   Last Updated: ${snapshot.lastUpdated}`);
